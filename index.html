<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ගණිත ක්‍රීඩා වෙබ් අඩවිය</title>
    <!-- Tailwind CSS CDN ඇතුළත් කිරීම -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* විශේෂ සජීවිකරණ (animations) සඳහා අමතර CSS */
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            40% { transform: translateX(5px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .fade-in {
            animation: fadeIn 1s ease-in-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .fly-out {
            animation: flyOut 0.4s ease-in forwards;
        }
        @keyframes flyOut {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.5); opacity: 0; filter: blur(2px); }
        }

        /* සංචාලන බොත්තම් වල ක්‍රියාකාරී පෙනුම සඳහා පන්තිය */
        .nav-btn-active {
            @apply text-purple-600 font-bold;
        }
        
        /* සංචාලන බාර් එක සඳහා CSS */
        .nav-bar {
            @apply h-1 bg-purple-600 rounded-full mt-2;
            transform: scaleX(0);
            transform-origin: center;
            transition: transform 0.3s ease-in-out;
        }

        .nav-bar-active {
            transform: scaleX(1);
        }

        /* නව පසුබිම් සජීවිකරණය සඳහා CSS */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -10;
        }

        .blob {
            position: absolute;
            /* පසුබිම වඩාත් සියුම් කිරීමට opacity අඩු කරන ලදී */
            border-radius: 50%;
            opacity: 0.3; 
            filter: blur(80px); 
            will-change: transform, opacity;
        }

        @keyframes blob-animation {
            0% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(20vw, 30vh) scale(1.2);
            }
            50% {
                transform: translate(-50vw, 10vh) scale(0.8);
            }
            75% {
                transform: translate(30vw, -40vh) scale(1.1);
            }
            100% {
                transform: translate(0, 0) scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans relative">
    <!-- වර්ණවත් බුබුළු වැනි සජීවිකරණ පසුබිම (Colorful bubble-like animated background) -->
    <div class="animated-background">
        <!-- විවිධ වර්ණ සහ සජීවිකරණ ප්‍රමාදයන් සහිත බුබුළු (Blobs with different colors and animation delays) -->
        <div class="blob w-96 h-96 -top-40 left-1/4 animate-[blob-animation_20s_ease-in-out_infinite_alternate] bg-blue-500"></div>
        <div class="blob w-72 h-72 -bottom-20 right-1/4 animate-[blob-animation_18s_ease-in-out_infinite_reverse] bg-purple-500"></div>
        <div class="blob w-64 h-64 top-1/2 -left-20 animate-[blob-animation_22s_ease-in-out_infinite_alternate] bg-pink-500"></div>
        <div class="blob w-80 h-80 bottom-1/4 left-1/2 -translate-x-1/2 animate-[blob-animation_15s_ease-in-out_infinite] bg-green-500"></div>
        <div class="blob w-56 h-56 top-10 right-10 animate-[blob-animation_25s_ease-in-out_infinite] bg-red-500"></div>
        <div class="blob w-60 h-60 bottom-0 left-0 animate-[blob-animation_17s_ease-in-out_infinite_reverse] bg-yellow-500"></div>
    </div>
    
    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">
        <!-- ක්‍රීඩාව සම්පූර්ණ තිරය පුරා පෙන්වීමට `max-w-4xl` ඉවත් කර ඇත -->
        <div class="w-full bg-white bg-opacity-50 rounded-xl shadow-2xl p-8 flex flex-col items-center relative z-10">
            
            <!-- පිටු සංචාලන බොත්තම් -->
            <nav class="w-full flex justify-center mb-8">
                <ul class="flex space-x-4 sm:space-x-8">
                    <li class="flex flex-col items-center">
                        <button id="nav-home" class="nav-btn px-4 py-2 font-semibold text-lg rounded-xl transition-all duration-300">මුල් පිටුව</button>
                        <div id="bar-home" class="nav-bar w-full"></div>
                    </li>
                    <li class="flex flex-col items-center">
                        <button id="nav-game" class="nav-btn px-4 py-2 font-semibold text-lg rounded-xl transition-all duration-300">ක්‍රීඩාව</button>
                        <div id="bar-game" class="nav-bar w-full"></div>
                    </li>
                    <li class="flex flex-col items-center">
                        <button id="nav-scoreboard" class="nav-btn px-4 py-2 font-semibold text-lg rounded-xl transition-all duration-300">ලකුණු පුවරුව</button>
                        <div id="bar-scoreboard" class="nav-bar w-full"></div>
                    </li>
                </ul>
            </nav>
            
            <!-- අන්තර්ගතය ප්‍රදර්ශනය කරන ප්‍රධාන කොටස -->
            <div id="content" class="w-full fade-in">
                <!-- JavaScript මගින් අන්තර්ගතය මෙහිදී ජනනය කරයි. -->
            </div>
            
        </div>
    </div>

    <script>
        // ක්‍රීඩාවේ තත්ත්වය කළමනාකරණය කරන ගෝලීය විචල්‍යයන්
        let currentPage = 'home';
        let finalScore = 0;
        let showGameModal = false;
        let score = 0;
        let problemsPlayed = 0;
        const totalProblems = 5;
        let currentProblem = null;
        let expressionItems = [];
        let history = [];
        let resultMessage = '';
        let isCorrect = null;

        // ගැටළු දත්ත
        const problems = [
            { target: 10, items: [8, 2, "+", 5, 3] },
            { target: 12, items: [5, 7, "+", 6, 2, "×"] },
            { target: 20, items: [4, 5, "×", 10, 2, "+"] },
            { target: 8, items: [16, 2, "÷", 4, 2, "-"] },
            { target: 15, items: [18, 3, "-", 10, 5, "÷"] },
            { target: 6, items: [12, 2, "÷", 3, 3, "+"] },
            { target: 25, items: [5, 5, "×", 20, 5, "-"] },
            { target: 9, items: [1, 8, "+", 10, 1, "-"] },
            { target: 100, items: [10, 10, "×", 5, 2, "×"] },
            { target: 3, items: [9, 3, "÷", 6, 2, "÷"] },
            { target: 7, items: [15, 8, "-", 10, 3, "-"] },
            { target: 18, items: [9, 9, "+", 20, 2, "-"] },
            { target: 30, items: [6, 5, "×", 25, 5, "+"] },
            { target: 2, items: [10, 8, "-", 5, 3, "×"] },
            { target: 7, items: [10, 9, 8, 2, "-", "-", 4, 3, "×"] }
        ];

        // පිටු අතර සංචාලනය සඳහා ශ්‍රිතයකි.
        const navigate = (page, finalScoreValue = 0) => {
            currentPage = page;
            if (page === 'scoreboard') {
                finalScore = finalScoreValue;
            }
            renderPage();
            updateNavButtons();
        };

        // සංචාලන බොත්තම් වල පෙනුම යාවත්කාලීන කිරීම
        const updateNavButtons = () => {
            // සියලුම බොත්තම් වල ක්‍රියාකාරී පන්තිය ඉවත් කිරීම
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('nav-btn-active');
            });
            // සියලුම බාර් වල ක්‍රියාකාරී පන්තිය ඉවත් කිරීම
            document.querySelectorAll('.nav-bar').forEach(bar => {
                bar.classList.remove('nav-bar-active');
            });

            // වත්මන් බොත්තම සහ අදාළ බාර් එක ක්‍රියාකාරී කිරීම
            const activeBtn = document.getElementById(`nav-${currentPage}`);
            const activeBar = document.getElementById(`bar-${currentPage}`);
            if (activeBtn) {
                activeBtn.classList.add('nav-btn-active');
            }
            if (activeBar) {
                activeBar.classList.add('nav-bar-active');
            }
        };

        // ගණිත ප්‍රකාශනයක් ආරක්ෂිතව ඇගයීමේ ශ්‍රිතයකි.
        const evaluateExpression = (expression) => {
            try {
                const sanitizedExpression = expression.replace(/[^0-9+\-*/().]/g, '');
                const evalExpression = sanitizedExpression.replace(/÷/g, '/').replace(/×/g, '*');
                const safeEvaluator = new Function(`return (${evalExpression});`);
                return safeEvaluator();
            } catch (e) {
                return NaN;
            }
        };

        // array එකක් මාරු කිරීමට උපකාරී වන ශ්‍රිතයකි.
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        // නව ගැටළුවක් උත්පාදනය කිරීමේ ශ්‍රිතයකි.
        const generateNewGame = () => {
            if (problemsPlayed >= totalProblems) {
                handleGameEnd(score);
                return;
            }
            
            const shuffledProblems = shuffleArray([...problems]);
            currentProblem = shuffledProblems[Math.floor(Math.random() * shuffledProblems.length)];
            expressionItems = shuffleArray([...currentProblem.items]);
            history = [];
            resultMessage = '';
            isCorrect = null;
            renderGameModal();
        };

        // ක්‍රීඩාව අවසන් වූ විට ක්‍රියාත්මක වන ශ්‍රිතය
        const handleGameEnd = (finalScoreValue) => {
            showGameModal = false;
            navigate('scoreboard', finalScoreValue);
        };

        // අයිතමයක් මත click කිරීම හැසිරවීම
        const handleItemClick = (item, clickedIndex) => {
            history.push(item);
            expressionItems = expressionItems.filter((_, i) => i !== clickedIndex);
            renderGameModal();
        };

        // අවසාන පියවර ආපසු ගැනීම
        const handleUndo = () => {
            if (history.length > 0) {
                const lastItem = history.pop();
                expressionItems.push(lastItem);
                renderGameModal();
            }
        };

        // පරිශීලකයාගේ ප්‍රකාශනය පරීක්ෂා කිරීම
        const handleCheck = () => {
            const expression = history.join('');
            const result = evaluateExpression(expression);

            if (result === currentProblem.target) {
                isCorrect = true;
                resultMessage = 'නිවැරදියි!';
                score += 10;
            } else {
                isCorrect = false;
                resultMessage = 'වැරදියි.';
                score = Math.max(0, score - 2);
            }

            // පරීක්ෂා කිරීමේ ප්‍රතිඵලය පෙන්වීමට කේතය නැවත යොමු කරන්න
            renderGameModal();

            setTimeout(() => {
                problemsPlayed++;
                generateNewGame();
            }, 1500);
        };

        // Home Page එකේ HTML කේතය
        const renderHomePage = () => {
            return `
                <div class="text-center p-6 sm:p-10 fade-in">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800 mb-4">ගණිත ක්‍රීඩාවට සාදරයෙන් පිළිගනිමු</h1>
                    <p class="text-md sm:text-xl text-gray-700 mb-8">
                        ඔබට දුන් අංක සහ ගණිත කර්ම භාවිතයෙන් නිවැරදි ප්‍රකාශනයක් සාදා ඉලක්කගත අගය ලබා ගත හැකිදැයි බලමු.
                    </p>
                    <button id="start-game-btn" class="bg-gradient-to-r from-green-400 to-green-600 text-white text-lg sm:text-2xl font-bold py-3 px-8 rounded-full shadow-lg hover:from-green-500 hover:to-green-700 transform hover:scale-105 transition-transform duration-300">
                        ක්‍රීඩාව ආරම්භ කරන්න
                    </button>
                </div>
            `;
        };

        // Game Page එකේ HTML කේතය
        const renderGamePage = () => {
            const levelButtons = [1, 2, 3, 4, 5, 6].map(level => `
                <button
                    class="start-math-btn bg-blue-500 text-white text-xl sm:text-2xl font-bold py-4 rounded-xl shadow-lg hover:bg-blue-600 transform hover:scale-105 transition-transform duration-300"
                >
                    ගණිත ක්‍රීඩාව ${level}
                </button>
            `).join('');

            return `
                <div class="text-center p-6 sm:p-10 fade-in">
                    <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">ක්‍රීඩා මට්ටම්</h2>
                    <p class="text-md sm:text-lg text-gray-600 mb-8">ඔබට කැමති මට්ටමක් තෝරා ක්‍රීඩා කළ හැක.</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
                        ${levelButtons}
                    </div>
                </div>
            `;
        };

        // Scoreboard Page එකේ HTML කේතය
        const renderScoreboardPage = () => {
            return `
                <div class="text-center p-6 sm:p-10 fade-in">
                    <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">ලකුණු පුවරුව</h2>
                    <p class="text-xl sm:text-2xl text-gray-600 mb-4">ඔබගේ අවසන් ලකුණු:</p>
                    <div class="text-5xl sm:text-7xl font-extrabold text-blue-600 mb-8">${finalScore}</div>
                    <button id="play-again-btn" class="bg-purple-500 text-white text-lg sm:text-xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-purple-600 transform hover:scale-105 transition-transform duration-300">
                        නැවත ක්‍රීඩා කරන්න
                    </button>
                </div>
            `;
        };
        
        // Game Modal එකේ HTML කේතය
        const renderGameModal = () => {
            // ජංගම දුරකථන සඳහා සම්පූර්ණ තිරය පිරවීමට h-screen සහ w-screen භාවිතා කරන ලදී.
            const modalContainerClass = `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 h-screen w-screen`;
            // ජංගම දුරකථන සඳහා padding අඩු කරන ලදී.
            const modalContentClass = `bg-white rounded-xl shadow-2xl p-4 sm:p-6 w-full h-full sm:h-auto sm:max-w-2xl transform transition-all duration-500 relative flex flex-col items-center justify-center ${isCorrect === true ? 'scale-105 shadow-green-500/50' : isCorrect === false ? 'shake-animation' : ''}`;
            
            const expressionItemButtons = expressionItems.map((item, index) => `
                <button
                    class="bg-blue-100 text-blue-800 font-bold px-4 py-2 rounded-lg shadow hover:bg-blue-200 transition-colors pop-in"
                    onclick="handleItemClick('${item}', ${index})"
                >
                    ${item}
                </button>
            `).join('');

            const historySpans = history.map((item, index) => `
                <span class="bg-white text-blue-800 font-bold px-4 py-2 rounded-lg shadow pop-in">
                    ${item}
                </span>
            `).join('');

            const resultMessageClass = `text-center font-bold text-lg mt-4 ${isCorrect ? 'text-green-600' : 'text-red-600'} pop-in`;

            const modalHtml = `
                <div id="game-modal" class="${modalContainerClass}">
                    <div class="${modalContentClass}">
                        <!-- ආපසු යාමේ බොත්තම -->
                        <button
                            class="absolute top-4 right-4 bg-gray-200 text-gray-600 text-sm font-bold py-2 px-4 rounded-full shadow-md hover:bg-gray-300 transition-colors transform hover:scale-105 duration-300"
                            onclick="handleGameEnd(0)"
                        >
                            ආපසු යන්න
                        </button>
                        
                        <h2 class="text-2xl sm:text-3xl font-bold text-blue-800 mb-4 text-center">ගණිත ක්‍රීඩාව</h2>
                        <div class="text-center mb-6">
                            <p class="text-xl sm:text-2xl font-bold text-gray-700">ලකුණු: ${score}</p>
                        </div>
                        <p class="text-lg sm:text-xl font-bold text-gray-700 mb-4 text-center">
                            දුන් අංක සහ සංකේත භාවිතයෙන් ${currentProblem.target} ට සමාන ප්‍රකාශනයක් සාදන්න.
                        </p>
                        <div class="flex justify-center flex-wrap gap-2 sm:gap-4 mb-6 p-4 bg-gray-200 rounded-lg border-2 border-dashed border-gray-400">
                            ${expressionItemButtons}
                        </div>
                        <div class="flex justify-center flex-wrap gap-2 sm:gap-4 mb-6 p-4 bg-blue-100 rounded-lg border-2 border-solid border-blue-400">
                            ${historySpans}
                        </div>
                        <div class="flex justify-center gap-4">
                            <button
                                class="bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-gray-600 transition-colors transform hover:scale-105 duration-300"
                                onclick="handleUndo()"
                                ${history.length === 0 ? 'disabled' : ''}
                            >
                                ආපසු ගන්න
                            </button>
                            <button
                                class="bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-green-600 transition-colors transform hover:scale-105 duration-300"
                                onclick="handleCheck()"
                            >
                                පරීක්ෂා කරන්න
                            </button>
                        </div>
                        ${resultMessage ? `<p class="${resultMessageClass}">${resultMessage}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Modal එක render කිරීම
            document.getElementById('content').innerHTML = modalHtml;
        };

        // පිටුව render කරන ප්‍රධාන ශ්‍රිතය
        const renderPage = () => {
            const contentDiv = document.getElementById('content');
            switch(currentPage) {
                case 'home':
                    contentDiv.innerHTML = renderHomePage();
                    // බොත්තම් වලට event listeners එකතු කිරීම
                    document.getElementById('start-game-btn').addEventListener('click', () => navigate('game'));
                    break;
                case 'game':
                    contentDiv.innerHTML = renderGamePage();
                    // 'onclick' හැර JavaScript මගින් Event Listener එකතු කිරීම
                    document.querySelectorAll('.start-math-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            score = 0;
                            problemsPlayed = 0;
                            showGameModal = true;
                            generateNewGame();
                        });
                    });
                    break;
                case 'scoreboard':
                    contentDiv.innerHTML = renderScoreboardPage();
                    document.getElementById('play-again-btn').addEventListener('click', () => navigate('game'));
                    break;
            }
        };

        // වෙබ් අඩවිය load වූ විට ආරම්භ කරන ශ්‍රිතය
        window.onload = function() {
            // සංචාලන බොත්තම් වලට event listeners එකතු කිරීම
            document.getElementById('nav-home').addEventListener('click', () => navigate('home'));
            document.getElementById('nav-game').addEventListener('click', () => navigate('game'));
            document.getElementById('nav-scoreboard').addEventListener('click', () => navigate('scoreboard'));
            
            // මුල් පිටුව render කිරීම
            navigate('home');
        };
    </script>
</body>
</html>
