import React, { useState, useEffect } from 'react';
import { createRoot } from 'react-dom/client';

// ප්‍රධාන App component එක, පිටු අතර සංචාලනය සහ තත්ත්වය කළමනාකරණය කරයි.
const App = () => {
  const [currentPage, setCurrentPage] = useState('home');
  const [finalScore, setFinalScore] = useState(0);

  // පිටු අතර සංචාලනය සඳහා ශ්‍රිතයකි.
  const navigate = (page, score = 0) => {
    setCurrentPage(page);
    if (page === 'scoreboard') {
      setFinalScore(score);
    }
  };

  const renderPage = () => {
    switch (currentPage) {
      case 'home':
        return <HomePage navigate={navigate} />;
      case 'game':
        return <GamePage navigate={navigate} />;
      case 'scoreboard':
        return <ScoreboardPage score={finalScore} navigate={navigate} />;
      default:
        return <HomePage navigate={navigate} />;
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100 font-sans">
      <div className="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 flex flex-col items-center">
        <nav className="w-full flex justify-center mb-8">
          <ul className="flex space-x-4 sm:space-x-8">
            <li>
              <button
                className={`text-lg sm:text-xl font-bold rounded-full px-4 sm:px-6 py-2 transition-all duration-300 ${
                  currentPage === 'home'
                    ? 'bg-blue-600 text-white shadow-md'
                    : 'text-gray-600 hover:bg-blue-100'
                }`}
                onClick={() => navigate('home')}
              >
                මුල් පිටුව
              </button>
            </li>
            <li>
              <button
                className={`text-lg sm:text-xl font-bold rounded-full px-4 sm:px-6 py-2 transition-all duration-300 ${
                  currentPage === 'game'
                    ? 'bg-blue-600 text-white shadow-md'
                    : 'text-gray-600 hover:bg-blue-100'
                }`}
                onClick={() => navigate('game')}
              >
                ක්‍රීඩාව
              </button>
            </li>
            <li>
              <button
                className={`text-lg sm:text-xl font-bold rounded-full px-4 sm:px-6 py-2 transition-all duration-300 ${
                  currentPage === 'scoreboard'
                    ? 'bg-blue-600 text-white shadow-md'
                    : 'text-gray-600 hover:bg-blue-100'
                }`}
                onClick={() => navigate('scoreboard')}
              >
                ලකුණු පුවරුව
              </button>
            </li>
          </ul>
        </nav>
        <div className="w-full">
          {renderPage()}
        </div>
      </div>
    </div>
  );
};

// මුල් පිටුව component එක
const HomePage = ({ navigate }) => {
  return (
    <div className="text-center p-6 sm:p-10">
      <h1 className="text-4xl sm:text-5xl font-extrabold text-blue-800 mb-4">ගණිත ක්‍රීඩාවට සාදරයෙන් පිළිගනිමු</h1>
      <p className="text-md sm:text-xl text-gray-700 mb-8">
        ඔබට දුන් අංක සහ ගණිත කර්ම භාවිතයෙන් නිවැරදි ප්‍රකාශනයක් සාදා ඉලක්කගත අගය ලබා ගත හැකිදැයි බලමු.
      </p>
      <button
        className="bg-green-500 text-white text-lg sm:text-2xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-600 transform hover:scale-105 transition-transform duration-300"
        onClick={() => navigate('game')}
      >
        ක්‍රීඩාව ආරම්භ කරන්න
      </button>
    </div>
  );
};

// ක්‍රීඩා පිටුව component එක
const GamePage = ({ navigate }) => {
  const [showGameModal, setShowGameModal] = useState(null);

  const startLevel = (gameType) => {
    setShowGameModal(gameType);
  };

  const handleGameEnd = (score) => {
    setShowGameModal(null);
    navigate('scoreboard', score);
  };

  return (
    <div className="text-center p-6 sm:p-10">
      <h2 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">ක්‍රීඩා මට්ටම්</h2>
      <p className="text-md sm:text-lg text-gray-600 mb-8">ඔබට කැමති මට්ටමක් තෝරා ක්‍රීඩා කළ හැක.</p>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
        {[1, 2, 3, 4, 5, 6].map((level) => (
          <button
            key={`math-${level}`}
            className="bg-blue-500 text-white text-xl sm:text-2xl font-bold py-4 rounded-xl shadow-lg hover:bg-blue-600 transform hover:scale-105 transition-transform duration-300"
            onClick={() => startLevel('math')}
          >
            ගණිත ක්‍රීඩාව {level}
          </button>
        ))}
      </div>
      {showGameModal === 'math' && <GameModal onGameEnd={handleGameEnd} />}
    </div>
  );
};

// ගණිත ක්‍රීඩාව සඳහා Modal component එක
const GameModal = ({ onGameEnd }) => {
  const [score, setScore] = useState(0);
  const [problemsPlayed, setProblemsPlayed] = useState(0);
  const totalProblems = 5;
  const [currentProblem, setCurrentProblem] = useState(null);
  const [expressionItems, setExpressionItems] = useState([]);
  const [history, setHistory] = useState([]);
  const [resultMessage, setResultMessage] = useState('');
  const [isCorrect, setIsCorrect] = useState(null);

  // ගැටළු දත්ත
  const problems = [
    { target: 10, items: [8, 2, "+", 5, 3] },
    { target: 12, items: [5, 7, "+", 6, 2, "×"] },
    { target: 20, items: [4, 5, "×", 10, 2, "+"] },
    { target: 8, items: [16, 2, "÷", 4, 2, "-"] },
    { target: 15, items: [18, 3, "-", 10, 5, "÷"] },
    { target: 6, items: [12, 2, "÷", 3, 3, "+"] },
    { target: 25, items: [5, 5, "×", 20, 5, "-"] },
    { target: 9, items: [1, 8, "+", 10, 1, "-"] },
    { target: 100, items: [10, 10, "×", 5, 2, "×"] },
    { target: 3, items: [9, 3, "÷", 6, 2, "÷"] },
    { target: 7, items: [15, 8, "-", 10, 3, "-"] },
    { target: 18, items: [9, 9, "+", 20, 2, "-"] },
    { target: 30, items: [6, 5, "×", 25, 5, "+"] },
    { target: 2, items: [10, 8, "-", 5, 3, "×"] },
    { target: 7, items: [10, 9, 8, 2, "-", "-", 4, 3, "×"] }
  ];

  // component එක mount වන විට හෝ නව මට්ටමක් ආරම්භ වන විට නව ක්‍රීඩාවක් උත්පාදනය කිරීමට useEffect භාවිතා කරයි.
  useEffect(() => {
    generateNewGame();
  }, []);

  // array එකක් මාරු කිරීමට උපකාරී වන ශ්‍රිතයකි.
  const shuffleArray = (array) => {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  };

  // නව ගැටළුවක් උත්පාදනය කිරීමේ ශ්‍රිතයකි.
  const generateNewGame = () => {
    if (problemsPlayed >= totalProblems) {
      onGameEnd(score);
      return;
    }

    const shuffledProblems = shuffleArray([...problems]);
    const newProblem = shuffledProblems[Math.floor(Math.random() * shuffledProblems.length)];
    setCurrentProblem(newProblem);
    setExpressionItems(shuffleArray([...newProblem.items]));
    setHistory([]);
    setResultMessage('');
    setIsCorrect(null);
  };

  // අයිතමයක් මත click කිරීම හැසිරවීම
  const handleItemClick = (item) => {
    setHistory((prevHistory) => [...prevHistory, item]);
    setExpressionItems((prevItems) => prevItems.filter((i) => i !== item));
  };

  // අවසාන පියවර ආපසු ගැනීම
  const handleUndo = () => {
    if (history.length > 0) {
      const lastItem = history[history.length - 1];
      setHistory((prevHistory) => prevHistory.slice(0, -1));
      setExpressionItems((prevItems) => [...prevItems, lastItem]);
    }
  };

  // ආරක්ෂිත ඇගයීමේ ශ්‍රිතයකි.
  const evaluateExpression = (expression) => {
    try {
      const sanitizedExpression = expression.replace(/[^0-9+\-*/().]/g, '');
      const evalExpression = sanitizedExpression.replace(/÷/g, '/').replace(/×/g, '*');
      const safeEvaluator = new Function(`return (${evalExpression});`);
      return safeEvaluator();
    } catch (e) {
      return NaN;
    }
  };

  // පරිශීලකයාගේ ප්‍රකාශනය පරීක්ෂා කිරීම
  const handleCheck = () => {
    const expression = history.join('');
    const result = evaluateExpression(expression);

    if (result === currentProblem.target) {
      setIsCorrect(true);
      setResultMessage('නිවැරදියි!');
      setScore(score + 10);
    } else {
      setIsCorrect(false);
      setResultMessage('වැරදියි.');
      setScore(Math.max(0, score - 2));
    }

    setTimeout(() => {
      setProblemsPlayed(problemsPlayed + 1);
      generateNewGame();
    }, 1500);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className={`bg-white rounded-xl shadow-2xl p-6 sm:p-10 w-full max-w-2xl transform transition-all duration-500 ${isCorrect === true ? 'scale-105 shadow-green-500/50' : isCorrect === false ? 'shake-animation' : ''}`}>
        <h2 className="text-2xl sm:text-3xl font-bold text-blue-800 mb-4 text-center">ගණිත ක්‍රීඩාව</h2>
        <div className="text-center mb-6">
          <p className="text-xl sm:text-2xl font-bold text-gray-700">ලකුණු: {score}</p>
        </div>
        {currentProblem && (
          <>
            <p className="text-lg sm:text-xl font-bold text-gray-700 mb-4 text-center">
              දුන් අංක සහ සංකේත භාවිතයෙන් {currentProblem.target} ට සමාන ප්‍රකාශනයක් සාදන්න.
            </p>
            <div className="flex justify-center flex-wrap gap-2 sm:gap-4 mb-6 p-4 bg-gray-200 rounded-lg border-2 border-dashed border-gray-400">
              {expressionItems.map((item, index) => (
                <button
                  key={`item-${index}`}
                  className="bg-blue-100 text-blue-800 font-bold px-4 py-2 rounded-lg shadow hover:bg-blue-200 transition-colors"
                  onClick={() => handleItemClick(item)}
                >
                  {item}
                </button>
              ))}
            </div>
            <div className="flex justify-center flex-wrap gap-2 sm:gap-4 mb-6 p-4 bg-blue-100 rounded-lg border-2 border-solid border-blue-400">
              {history.map((item, index) => (
                <span key={`history-${index}`} className="bg-white text-blue-800 font-bold px-4 py-2 rounded-lg shadow">
                  {item}
                </span>
              ))}
            </div>
          </>
        )}
        <div className="flex justify-center gap-4">
          <button
            className="bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-gray-600 transition-colors"
            onClick={handleUndo}
            disabled={history.length === 0}
          >
            ආපසු ගන්න
          </button>
          <button
            className="bg-green-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-green-600 transition-colors"
            onClick={handleCheck}
          >
            පරීක්ෂා කරන්න
          </button>
          <button
            className="bg-red-500 text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transition-colors"
            onClick={() => onGameEnd(0)}
          >
            ක්‍රීඩාවෙන් ඉවත් වන්න
          </button>
        </div>
        {resultMessage && (
          <p className={`text-center font-bold text-lg mt-4 ${isCorrect ? 'text-green-600' : 'text-red-600'}`}>
            {resultMessage}
          </p>
        )}
      </div>
      <style>{`
        .shake-animation {
          animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
          0% { transform: translateX(0); }
          20% { transform: translateX(-5px); }
          40% { transform: translateX(5px); }
          60% { transform: translateX(-5px); }
          80% { transform: translateX(5px); }
          100% { transform: translateX(0); }
        }
      `}</style>
    </div>
  );
};

// ලකුණු පුවරුව component එක
const ScoreboardPage = ({ score, navigate }) => {
  return (
    <div className="text-center p-6 sm:p-10">
      <h2 className="text-3xl sm:text-4xl font-bold text-gray-800 mb-6">ලකුණු පුවරුව</h2>
      <p className="text-xl sm:text-2xl text-gray-600 mb-4">ඔබගේ අවසන් ලකුණු:</p>
      <div className="text-5xl sm:text-7xl font-extrabold text-blue-600 mb-8">{score}</div>
      <button
        className="bg-purple-500 text-white text-lg sm:text-xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-purple-600 transform hover:scale-105 transition-transform duration-300"
        onClick={() => navigate('game')}
      >
        නැවත ක්‍රීඩා කරන්න
      </button>
    </div>
  );
};

export default App;
